appId: com.fogofdog.app
jsEngine: graaljs
---
# Ground Truth Comparison Test: Background vs Foreground GPS Tracking
# This test validates that background GPS tracking produces identical fog-clearing 
# patterns as foreground tracking by comparing screenshots of the same GPS sequence.

# Test Strategy:
# 1. Foreground Baseline: Login → inject GPS coordinates while foreground → screenshot
# 2. Background Validation: Login → inject same coordinates with phone lock → screenshot  
# 3. Image Comparison: Verify patterns are near-identical using PSNR/SSIM

# Enhanced GPS Coordinate Pattern (Distinctive Zigzag - No Overlap)
# Point 1: Login location (37.78825, -122.4324)
# Point 2: 1000m South (37.779266, -122.4324)
# Point 3: 2000m East (37.779266, -122.409572) - Zigzag start
# Point 4: NE zigzag (37.785266, -122.415572)
# Point 5: SE zigzag (37.781266, -122.421572) - Adjusted to avoid overlap
# Point 6: NE zigzag (37.787266, -122.427572) - Adjusted to avoid overlap
# Point 7: Final position (37.792742, -122.409572)

# =============================================================================
# SEQUENCE 1: FOREGROUND BASELINE (Ground Truth)
# =============================================================================

# 1.1 Setup - Fresh app launch and login
- setLocation:
    latitude: 37.78825
    longitude: -122.4324
- launchApp:
    appId: com.fogofdog.app
    clearState: true
- runFlow:
    file: robust-login.yaml
- waitForAnimationToEnd:
    timeout: 1000
- assertVisible:
    text: "You are here"

# 1.2 Inject GPS sequence while app is in FOREGROUND
- setLocation:
    latitude: 37.779266
    longitude: -122.4324
- waitForAnimationToEnd:
    timeout: 800
- tapOn:
    id: "location-button"
- waitForAnimationToEnd:
    timeout: 500

- setLocation:
    latitude: 37.779266
    longitude: -122.409572
- waitForAnimationToEnd:
    timeout: 800
- tapOn:
    id: "location-button"
- waitForAnimationToEnd:
    timeout: 500

- setLocation:
    latitude: 37.785266
    longitude: -122.415572
- waitForAnimationToEnd:
    timeout: 800
- tapOn:
    id: "location-button"
- waitForAnimationToEnd:
    timeout: 500

- setLocation:
    latitude: 37.781266
    longitude: -122.421572
- waitForAnimationToEnd:
    timeout: 800
- tapOn:
    id: "location-button"
- waitForAnimationToEnd:
    timeout: 500

- setLocation:
    latitude: 37.787266
    longitude: -122.427572
- waitForAnimationToEnd:
    timeout: 800
- tapOn:
    id: "location-button"
- waitForAnimationToEnd:
    timeout: 500

- setLocation:
    latitude: 37.792742
    longitude: -122.409572
- waitForAnimationToEnd:
    timeout: 800
- tapOn:
    id: "location-button"
- waitForAnimationToEnd:
    timeout: 500

# 1.3 Zoom out to show complete pattern (deterministic zoom level)
- tapOn:
    point: 450,300  # Center of screen
- waitForAnimationToEnd:
    timeout: 500
# Zoom out to show full pattern
- tapOn:
    point: 400,250
- tapOn:
    point: 500,350
- waitForAnimationToEnd:
    timeout: 1000
- tapOn:
    point: 400,250
- tapOn:
    point: 500,350
- waitForAnimationToEnd:
    timeout: 1000

# 1.4 Take baseline screenshot
- takeScreenshot: foreground_baseline
- waitForAnimationToEnd:
    timeout: 500

# 1.5 Logout and reset app state
- pressKey: Home
- waitForAnimationToEnd:
    timeout: 1000

# =============================================================================
# SEQUENCE 2: BACKGROUND VALIDATION (Test Subject)
# =============================================================================

# 2.1 Setup - Fresh app launch and login (identical to baseline)
- setLocation:
    latitude: 37.78825
    longitude: -122.4324
- launchApp:
    appId: com.fogofdog.app
    clearState: true
- runFlow:
    file: robust-login.yaml
- waitForAnimationToEnd:
    timeout: 1000
- assertVisible:
    text: "You are here"

# 2.2 Move to starting position before backgrounding
- setLocation:
    latitude: 37.779266
    longitude: -122.4324
- waitForAnimationToEnd:
    timeout: 800
- tapOn:
    id: "location-button"
- waitForAnimationToEnd:
    timeout: 500

# 2.3 Background app (simple backgrounding)
- pressKey: Home
- waitForAnimationToEnd:
    timeout: 2000

# 2.4 Inject GPS sequence while phone is LOCKED (same sequence as foreground)
- setLocation:
    latitude: 37.779266
    longitude: -122.409572
- waitForAnimationToEnd:
    timeout: 800

- setLocation:
    latitude: 37.785266
    longitude: -122.415572
- waitForAnimationToEnd:
    timeout: 800

- setLocation:
    latitude: 37.781266
    longitude: -122.421572
- waitForAnimationToEnd:
    timeout: 800

- setLocation:
    latitude: 37.787266
    longitude: -122.427572
- waitForAnimationToEnd:
    timeout: 800

- setLocation:
    latitude: 37.792742
    longitude: -122.409572
- waitForAnimationToEnd:
    timeout: 800

# 2.5 Return to app
- waitForAnimationToEnd:
    timeout: 1000

# 2.6 Foreground the app and process stored locations
- launchApp:
    appId: com.fogofdog.app
    clearState: false  # Try to preserve state first
- waitForAnimationToEnd:
    timeout: 2000

# Check if we're on map screen or need to login again
- runFlow:
    when:
        visible: "Sign In"
    commands:
        # If we see "Sign In", login again
        - runFlow:
            file: robust-login.yaml
        - waitForAnimationToEnd:
            timeout: 2000

# Now we should be on the map screen
- assertVisible:
    id: "map-screen"
- waitForAnimationToEnd:
    timeout: 3000  # Time for background location processing
- tapOn:
    id: "location-button"
- waitForAnimationToEnd:
    timeout: 500

# 2.7 Zoom out to same level as baseline (identical zoom sequence)
- tapOn:
    point: 450,300  # Center of screen
- waitForAnimationToEnd:
    timeout: 500
# Zoom out to show full pattern (same as baseline)
- tapOn:
    point: 400,250
- tapOn:
    point: 500,350
- waitForAnimationToEnd:
    timeout: 1000
- tapOn:
    point: 400,250
- tapOn:
    point: 500,350
- waitForAnimationToEnd:
    timeout: 1000

# 2.8 Take comparison screenshot
- takeScreenshot: background_test
- waitForAnimationToEnd:
    timeout: 500

# =============================================================================
# VALIDATION: Image Comparison
# =============================================================================

# Note: Image comparison will be handled by the test runner script
# Expected: PSNR > 30dB (indicating >95% similarity between images)
# This validates that background GPS tracking produces identical fog patterns

# Final assertions to ensure test completed successfully
- assertVisible:
    id: "map-screen"
- assertVisible:
    text: "You are here"

# Test completion message
# SUCCESS: If this test completes, both sequences executed successfully
# The image comparison will determine if background tracking matches foreground behavior