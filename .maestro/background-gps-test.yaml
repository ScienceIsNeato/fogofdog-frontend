appId: com.fogofdog.app
jsEngine: graaljs
---
# Background GPS Test: Background tracking + foreground state validation
#
# Validates that GPS points accumulated while the app is backgrounded are
# applied immediately on return (no step-by-step replay animation).
#
# Sequence:
#   1. Inject 120 historical GPS points (simulates earlier session)
#   2. Launch to map, move once to establish foreground path
#   3. Background the app
#   4. Inject 8 GPS points while backgrounded (zigzag pattern)
#   5. Foreground — verify immediate state, no replay animation
#   6. Move to distant unexplored point — verify fog still present
#
# Preconditions: run_integration_tests.sh pre-seeds app state (onboarding
# completed, permissions granted). No conditionals needed.

# 0. Inject historical GPS data (120 points from a simulated earlier walk)
- runScript: shared/inject-starting-data.js

# 1. Set initial GPS before launch
- setLocation:
    latitude: 37.78825
    longitude: -122.4324

# 2. Launch directly to map (zero UI gates)
- runFlow:
    file: shared/launch-to-map.yaml

# @checkpoint: 01-initial-map
# @description: MapScreen after launch with 120 historical GPS points loaded.
#   Fog holes should exist along the historical path. Current position marker
#   at (37.788, -122.432). HUD buttons visible.
- takeScreenshot: 01-initial-map

# 3. Move 1000m south (establish active foreground path)
- runFlow:
    file: shared/move-and-settle.yaml
    env:
      MOVE_LAT: '37.779266'
      MOVE_LON: '-122.4324'

# @checkpoint: 02-pre-background
# @description: Map after moving 1000m south. Position marker at (37.779, -122.432).
#   Fog hole visible at both start and current position.
- takeScreenshot: 02-pre-background

# 4. Background the app
- pressKey: Home
- waitForAnimationToEnd:
    timeout: 2000

# 5. Inject 8 GPS points while backgrounded (zigzag pattern ~2km spread)
- setLocation:
    latitude: 37.779266
    longitude: -122.409572 # A: 2000m East
- waitForAnimationToEnd:
    timeout: 600
- setLocation:
    latitude: 37.785266
    longitude: -122.415572 # B: NE zigzag
- waitForAnimationToEnd:
    timeout: 600
- setLocation:
    latitude: 37.779266
    longitude: -122.421572 # C: SE zigzag
- waitForAnimationToEnd:
    timeout: 600
- setLocation:
    latitude: 37.785266
    longitude: -122.427572 # D: NE zigzag
- waitForAnimationToEnd:
    timeout: 600
- setLocation:
    latitude: 37.781266
    longitude: -122.433572 # E: Continue pattern
- waitForAnimationToEnd:
    timeout: 600
- setLocation:
    latitude: 37.787266
    longitude: -122.439572 # F: More distance
- waitForAnimationToEnd:
    timeout: 600
- setLocation:
    latitude: 37.783266
    longitude: -122.445572 # G: Complex path
- waitForAnimationToEnd:
    timeout: 600
- setLocation:
    latitude: 37.789266
    longitude: -122.451572 # H: Final background point
- waitForAnimationToEnd:
    timeout: 600

# 6. Foreground the app — CRITICAL: must respond immediately, not replay
- launchApp:
    appId: com.fogofdog.app
    clearState: false

# Verify immediate responsiveness (replay bug would cause timeout/jank)
- extendedWaitUntil:
    visible:
      id: 'location-button'
    timeout: 5000
- tapOn:
    id: 'location-button'
- extendedWaitUntil:
    visible:
      id: 'map-screen'
    timeout: 3000

# @checkpoint: 03-post-foreground
# @description: Map immediately after foregrounding. All 8 background GPS points
#   should be applied — fog holes visible along the zigzag path. No replay
#   animation visible. Camera centered on last background point (37.789, -122.452).
#   Location button responded immediately (no animation delay).
- takeScreenshot: 03-post-foreground

# 7. Move to distant unexplored point — fog should still be there
- runFlow:
    file: shared/move-and-settle.yaml
    env:
      MOVE_LAT: '37.864611'
      MOVE_LON: '-122.386744'

# Confirm no stale loading states
- assertNotVisible:
    text: 'Loading location'
    optional: true

# @checkpoint: 04-distant-unexplored
# @description: Map at distant point (37.865, -122.387) that was NOT part of any
#   GPS sequence. This area should be fully covered by fog. Validates fog system
#   didn't erroneously clear everything. Position marker visible at new location.
- takeScreenshot: 04-distant-unexplored
