name: EAS Build & Deploy

on:
  # Trigger after version-bump workflow completes (PR merge flow)
  # version-bump.yml creates a git tag, so we DON'T also trigger on push:tags
  # to avoid duplicate builds (workflow_run + tag push would both fire).
  workflow_run:
    workflows: ['Auto Version Bump']
    types: [completed]
    branches: [main]
  # Manual builds (also used for production releases instead of push:tags)
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform to build'
        required: true
        default: 'ios'
        type: choice
        options:
          - ios
          - android
          - all
      profile:
        description: 'Build profile'
        required: true
        default: 'testflight'
        type: choice
        options:
          - preview
          - testflight
          - production
      skip_tests:
        description: 'Skip tests (for faster debugging builds)'
        required: false
        default: false
        type: boolean
      submit_to_testflight:
        description: 'Submit to TestFlight after build (iOS only)'
        required: false
        default: false
        type: boolean
      build_message:
        description: 'Custom build message/notes'
        required: false
        default: 'Manual build triggered'
        type: string

jobs:
  build:
    name: EAS Build (${{ github.event_name == 'workflow_dispatch' && github.event.inputs.build_message || 'Auto Deploy' }})
    runs-on: ubuntu-latest
    # Only run if triggered manually or if version-bump succeeded
    if: >
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # For workflow_run, we need to checkout the updated main with version bump
          ref: ${{ github.event_name == 'workflow_run' && 'main' || github.ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Setup Expo CLI
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Install dependencies
        run: npm ci

      - name: Run tests before build
        if: github.event_name != 'workflow_dispatch' || github.event.inputs.skip_tests != 'true'
        run: npm run test:ci

      - name: Build Info
        run: |
          echo "ðŸ—ï¸ Build Information:"
          echo "Branch: ${{ github.ref_name }}"
          echo "Trigger: ${{ github.event_name }}"
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "Platform: ${{ github.event.inputs.platform }}"
            echo "Profile: ${{ github.event.inputs.profile }}"
            echo "Skip Tests: ${{ github.event.inputs.skip_tests }}"
            echo "Submit to TestFlight: ${{ github.event.inputs.submit_to_testflight }}"
            echo "Message: ${{ github.event.inputs.build_message }}"
          fi

      - name: Build iOS for TestFlight (after version bump)
        if: github.event_name == 'workflow_run'
        run: eas build --platform ios --profile testflight --non-interactive

      - name: Build Manual Trigger
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "ðŸš€ Manual build triggered on branch: ${{ github.ref_name }}"
          echo "Message: ${{ github.event.inputs.build_message }}"
          eas build \
            --platform ${{ github.event.inputs.platform }} \
            --profile ${{ github.event.inputs.profile }} \
            --non-interactive \
            --message "${{ github.event.inputs.build_message }}"

  submit-testflight:
    name: Submit to TestFlight
    runs-on: ubuntu-latest
    needs: build
    if: >
      github.event_name == 'workflow_run' ||
      (github.event_name == 'workflow_dispatch' && 
       github.event.inputs.submit_to_testflight == 'true' &&
       (github.event.inputs.platform == 'ios' || github.event.inputs.platform == 'all'))

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup Expo CLI
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: ðŸ“‹ Submission Info
        run: |
          echo "ðŸ“± TestFlight Submission:"
          echo "Branch: ${{ github.ref_name }}"
          echo "Trigger: ${{ github.event_name }}"
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "Manual submission requested"
            echo "Message: ${{ github.event.inputs.build_message }}"
          fi

      - name: Submit to TestFlight
        run: eas submit --platform ios --latest --non-interactive --profile testflight
