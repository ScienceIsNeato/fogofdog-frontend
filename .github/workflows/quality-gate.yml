name: ðŸš€ Speed-Focused Quality Gate
on:
  push:
    branches: [main, develop, feature/*]
  pull_request:
    branches: [main]

jobs:
  # Fast quality checks (< 2 minutes)
  quality-checks:
    name: ðŸ” Quality Checks
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: âš¡ Install dependencies
        run: npm ci --legacy-peer-deps
        
      - name: ðŸ”’ Security Audit (High Priority Only)
        run: npm audit --audit-level high
        continue-on-error: true # Don't fail on warnings
        
      - name: ðŸ§¹ Lint Check (Zero Warnings)
        run: npm run lint:strict
        
      - name: ðŸ”§ TypeScript Check
        run: npx tsc --noEmit --strict
        
      - name: ðŸ¥ Expo Doctor
        run: npx expo doctor
        
      - name: ðŸ“Š Test with Coverage
        run: npm run test:coverage
        
      - name: ðŸ“ˆ Upload Coverage to CodeClimate
        uses: paambaati/codeclimate-action@v3.0.0
        env:
          CC_TEST_REPORTER_ID: ${{ secrets.CC_TEST_REPORTER_ID }}
        with:
          coverageLocations: coverage/lcov.info:lcov
        continue-on-error: true

  # Build verification (< 3 minutes)
  build-check:
    name: ðŸ”¨ Build Verification
    runs-on: ubuntu-latest
    timeout-minutes: 8
    needs: quality-checks
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: âš¡ Install dependencies
        run: npm ci --legacy-peer-deps
        
      - name: ðŸ—ï¸ Expo Export (iOS)
        run: npx expo export --platform ios
        
      - name: ðŸ—ï¸ Expo Export (Android) 
        run: npx expo export --platform android
        
      - name: ðŸ“± EAS Build Dry Run (iOS)
        run: npx eas build --platform ios --profile testflight --dry-run
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        continue-on-error: true
        
      - name: ðŸ“¦ Bundle Analysis
        run: |
          npx expo export --platform ios
          echo "ðŸ“Š Bundle size check completed"
        continue-on-error: true

  # Optional: Full EAS build only on main branch
  production-build:
    name: ðŸš€ Production Build
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [quality-checks, build-check]
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: âš¡ Install dependencies
        run: npm ci --legacy-peer-deps
        
      - name: ðŸš€ EAS Build (TestFlight)
        run: npx eas build --platform ios --profile testflight --auto-submit
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        continue-on-error: true 

  # Advanced code quality analysis (optional, runs in parallel)
  code-quality:
    name: ðŸ” Advanced Code Quality
    runs-on: ubuntu-latest
    timeout-minutes: 5
    continue-on-error: true # Don't fail the whole pipeline
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: âš¡ Install dependencies
        run: npm ci --legacy-peer-deps
        
      - name: ðŸŽ¨ Code Formatting Check
        run: npm run format:check
        
      - name: ðŸ§¹ Dead Code Detection
        run: npm run deadcode:check
        continue-on-error: true # Report but don't fail
        
      - name: ðŸ“¦ Dependency Analysis
        run: npm run deps:outdated
        continue-on-error: true # Report but don't fail 