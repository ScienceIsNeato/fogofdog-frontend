name: ðŸš€ Streamlined Quality Gate

on:
  push:
    branches: [main, develop, feature/*]
  pull_request:
    branches: [main]

env:
  EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

jobs:
  # Single comprehensive quality check job
  quality-gate:
    name: ðŸŽ¯ Quality Gate
    runs-on: ubuntu-latest
    timeout-minutes: 12
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Needed for SonarQube
        
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: âš¡ Install dependencies
        run: npm ci --legacy-peer-deps
        
      - name: ðŸ”’ Security Audit (High Priority Only)
        run: npm audit --audit-level high
        continue-on-error: true
        
      # Fast quality checks (< 2 minutes total)
      - name: ðŸŽ¯ Fast Quality Checks
        run: ./scripts/dev-check.sh
        
      # SonarQube analysis (only for PRs to main)
      - name: ðŸ” SonarQube Analysis
        if: github.event_name == 'pull_request' && github.base_ref == 'main'
        run: ./scripts/dev-check.sh --full
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  # Integration tests (separate job for iOS simulator requirements)
  integration-tests:
    name: ðŸŽ­ Integration Tests
    runs-on: macos-latest
    timeout-minutes: 15
    needs: quality-gate
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.base_ref == 'main')
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: âš¡ Install dependencies
        run: npm ci --legacy-peer-deps
        
      - name: ðŸŽ­ Run Integration Tests
        run: ./scripts/run_integration_tests.sh
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

  # Build verification (only when quality gate passes)
  build-verification:
    name: ðŸ”¨ Build Verification
    runs-on: ubuntu-latest
    timeout-minutes: 8
    needs: quality-gate
    if: github.event_name == 'pull_request' && github.base_ref == 'main'
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: âš¡ Install dependencies
        run: npm ci --legacy-peer-deps
        
      - name: ðŸ—ï¸ Expo Export Verification
        run: |
          echo "ðŸ” Verifying iOS export..."
          npx expo export --platform ios
          echo "ðŸ” Verifying Android export..."
          npx expo export --platform android
          echo "âœ… Export verification complete"
        
      - name: ðŸ“± EAS Build Dry Run
        run: |
          if [ -z "${{ env.EXPO_TOKEN }}" ]; then
            echo "EXPO_TOKEN not available - skipping EAS dry run"
            exit 0
          fi
          npx eas build --platform ios --profile testflight --dry-run
        continue-on-error: true

  # Production build (only for main branch merges)
  production-build:
    name: ðŸš€ Production Build
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [quality-gate, build-verification]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: âš¡ Install dependencies
        run: npm ci --legacy-peer-deps
        
      - name: ðŸ”§ Setup EAS CLI
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}
        
      - name: ðŸš€ Production Build (TestFlight)
        run: |
          if [ -z "$EXPO_TOKEN" ]; then
            echo "âŒ EXPO_TOKEN not available - cannot build for production"
            exit 1
          fi
          echo "ðŸ”¨ Building for TestFlight..."
          eas build --platform ios --profile testflight --auto-submit
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

  # Optional: Advanced analysis (runs in parallel, doesn't block)
  advanced-analysis:
    name: ðŸ“Š Advanced Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 5
    continue-on-error: true
    if: github.event_name == 'pull_request'
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: âš¡ Install dependencies
        run: npm ci --legacy-peer-deps
        
      - name: ðŸ“¦ Dependency Analysis
        run: |
          echo "ðŸ” Checking for outdated dependencies..."
          npm outdated || true
          echo "ðŸ” Checking for unused dependencies..."
          npx depcheck || true
        continue-on-error: true
        
      - name: ðŸ“Š Bundle Size Analysis
        run: |
          echo "ðŸ“Š Analyzing bundle size..."
          npx expo export --platform ios
          du -sh dist/ || echo "Bundle analysis complete"
        continue-on-error: true 