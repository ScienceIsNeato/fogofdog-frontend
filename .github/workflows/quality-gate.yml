name: ðŸš€ Speed-Focused Quality Gate
on:
  push:
    branches: [main, develop, feature/*]
  pull_request:
    branches: [main]

env:
  EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

jobs:
  # Fast quality checks (< 2 minutes)
  quality-checks:
    name: ðŸ” Quality Checks
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: âš¡ Install dependencies
        run: npm ci --legacy-peer-deps
        
      - name: ðŸ”’ Security Audit (High Priority Only)
        run: npm audit --audit-level high
        continue-on-error: true # Don't fail on warnings
        
      - name: ðŸ§¹ Lint Check (Zero Warnings)
        run: npm run lint:strict
        
      - name: ðŸ”§ TypeScript Check
        run: |
          echo "ðŸ” Running TypeScript type checking with strict configuration..."
          npm run type-check-ci
        
      - name: ðŸ“Š Test with Coverage
        run: npm run test:coverage
        
  # Build verification (< 3 minutes)
  build-check:
    name: ðŸ”¨ Build Verification
    runs-on: ubuntu-latest
    timeout-minutes: 8
    needs: quality-checks
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: âš¡ Install dependencies
        run: npm ci --legacy-peer-deps
        
      - name: ðŸ—ï¸ Expo Export (iOS)
        run: npx expo export --platform ios
        
      - name: ðŸ—ï¸ Expo Export (Android) 
        run: npx expo export --platform android
        
      - name: ðŸ“± EAS Build Dry Run (iOS)
        run: |
          if [ -z "${{ env.EXPO_TOKEN }}" ]; then
            echo "EXPO_TOKEN not available - skipping EAS operations"
            exit 0
          fi
          npx eas build --platform ios --profile testflight --dry-run
        continue-on-error: true
        
      - name: ðŸ“¦ Bundle Analysis
        run: |
          npx expo export --platform ios
          echo "ðŸ“Š Bundle size check completed"
        continue-on-error: true

  # PR Production Build Verification - Only for PRs to main, required for merge
  pr-build-verification:
    name: ðŸ” PR Build Verification (Required for Merge)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [quality-checks, build-check]
    if: github.event_name == 'pull_request' && github.base_ref == 'main'
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: âš¡ Install dependencies
        run: npm ci --legacy-peer-deps
        
      - name: ðŸ”§ Setup EAS CLI
        run: npm install -g @expo/eas-cli
        
      - name: ðŸš€ Production Build Verification (iOS)
        run: |
          if [ -z "$EXPO_TOKEN" ]; then
            echo "âŒ EXPO_TOKEN not available - cannot verify production builds"
            echo "This is required for merge to main branch"
            exit 1
          fi
          echo "ðŸ”¨ Running production build verification..."
          npx eas build --platform ios --profile testflight --non-interactive --wait
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        
      - name: âœ… Build Verification Complete
        run: |
          echo "âœ… Production build verification successful!"
          echo "ðŸš€ PR is ready for merge - builds are working correctly"

  # Optional: Full EAS build only on main branch
  production-build:
    name: ðŸš€ Production Build
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [quality-checks, build-check]
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: âš¡ Install dependencies
        run: npm ci --legacy-peer-deps
        
      - name: ðŸš€ EAS Build (TestFlight)
        run: |
          if [ -z "$EXPO_TOKEN" ]; then
            echo "EXPO_TOKEN not available - skipping EAS operations"
            exit 0
          fi
          npx eas build --platform ios --profile testflight --auto-submit
        continue-on-error: true

  # Advanced code quality analysis (optional, runs in parallel)
  code-quality:
    name: ðŸ” Advanced Code Quality
    runs-on: ubuntu-latest
    timeout-minutes: 5
    continue-on-error: true # Don't fail the whole pipeline
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: âš¡ Install dependencies
        run: npm ci --legacy-peer-deps
        
      - name: ðŸŽ¨ Code Formatting Check
        run: npm run format:check
        
      - name: ðŸ§¹ Dead Code Detection
        run: npm run deadcode:check
        continue-on-error: true # Report but don't fail
        
      - name: ðŸ“¦ Dependency Analysis
        run: npm run deps:outdated
        continue-on-error: true # Report but don't fail 