name: ğŸ¤– maintainAIbility-gate

on:
  push:
    branches: [main, develop]  # Only run on push to main/develop (not feature branches)
  pull_request:
    branches: [main]  # Run on PRs to main

env:
  EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

jobs:
  # Foundation Layer - Basic Code Quality (run in parallel)
  format-code:
    name: ğŸ“ Format Code
    runs-on: ubuntu-latest
    timeout-minutes: 3
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: âš¡ Install dependencies
        run: npm ci --legacy-peer-deps
        
      - name: ğŸ“ Run Prettier Code Formatting
        run: ./scripts/maintainAIbility-gate.sh --format

  lint-typescript:
    name: ğŸ” Lint TypeScript
    runs-on: ubuntu-latest
    timeout-minutes: 3
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: âš¡ Install dependencies
        run: npm ci --legacy-peer-deps
        
      - name: ğŸ” Run ESLint TypeScript Linting
        run: ./scripts/maintainAIbility-gate.sh --lint

  # Static Analysis Layer - Depends on clean code
  check-typescript-types:
    name: ğŸ—ï¸ Check TypeScript Types
    runs-on: ubuntu-latest
    timeout-minutes: 4
    needs: [format-code, lint-typescript]
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: âš¡ Install dependencies
        run: npm ci --legacy-peer-deps
        
      - name: ğŸ—ï¸ Run TypeScript Compiler
        run: ./scripts/maintainAIbility-gate.sh --types

  detect-code-duplication:
    name: ğŸ”„ Detect Code Duplication
    runs-on: ubuntu-latest
    timeout-minutes: 3
    needs: [format-code, lint-typescript]
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: âš¡ Install dependencies
        run: npm ci --legacy-peer-deps
        
      - name: ğŸ”„ Run JSCPD Duplication Detection
        run: ./scripts/maintainAIbility-gate.sh --duplication

  audit-security-vulnerabilities:
    name: ğŸ”’ Audit Security Vulnerabilities
    runs-on: ubuntu-latest
    timeout-minutes: 3
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: âš¡ Install dependencies
        run: npm ci --legacy-peer-deps
        
      - name: ğŸ”’ Run NPM Security Audit
        run: npm audit --audit-level high
        continue-on-error: true

  # Testing Layer - Depends on static analysis
  run-unit-tests-with-coverage:
    name: ğŸ§ª Run Unit Tests with Coverage
    runs-on: ubuntu-latest
    timeout-minutes: 8
    needs: [check-typescript-types, detect-code-duplication]
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: âš¡ Install dependencies
        run: npm ci --legacy-peer-deps
        
      - name: ğŸ§ª Run Jest Unit Tests with Coverage Reports
        run: ./scripts/maintainAIbility-gate.sh --tests

  # Integration Layer - Depends on unit tests
  run-maestro-integration-tests:
    name: ğŸ­ Run Maestro Integration Tests
    runs-on: macos-latest
    timeout-minutes: 30
    needs: run-unit-tests-with-coverage
    if: github.event_name == 'pull_request' && github.base_ref == 'main'
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: âš¡ Install dependencies
        run: npm ci --legacy-peer-deps
        
      - name: ğŸ”§ Setup EAS CLI
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}
        
      - name: ğŸ” Debug Environment
        run: |
          echo "ğŸ” Environment debugging..."
          echo "Node version: $(node --version)"
          echo "NPM version: $(npm --version)"
          echo "PATH: $PATH"
          echo "EAS CLI available: $(command -v eas || echo 'not found')"
          if command -v eas; then
            echo "EAS version: $(eas --version)"
          fi
          echo "EXPO_TOKEN set: ${{ secrets.EXPO_TOKEN != '' }}"
        
      - name: ğŸ­ Execute Maestro Integration Test Suite
        run: ./scripts/run_integration_tests.sh
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

  analyze-code-quality-with-sonarqube:
    name: ğŸ“Š Analyze Code Quality with SonarQube
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [check-typescript-types, detect-code-duplication, run-unit-tests-with-coverage]
    if: github.event_name == 'pull_request' && github.base_ref == 'main'
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Needed for SonarQube
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: âš¡ Install dependencies
        run: npm ci --legacy-peer-deps
        
      - name: ğŸ“Š Run SonarQube Code Quality Analysis
        run: ./scripts/maintainAIbility-gate.sh --sonar
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  # Build Layer - Depends on testing
  verify-expo-build-process:
    name: ğŸ”¨ Verify Expo Build Process
    runs-on: ubuntu-latest
    timeout-minutes: 8
    needs: run-unit-tests-with-coverage
    if: github.event_name == 'pull_request' && github.base_ref == 'main'
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: âš¡ Install dependencies
        run: npm ci --legacy-peer-deps
        
      - name: ğŸ—ï¸ Test Expo Export for iOS and Android
        run: |
          echo "ğŸ” Verifying iOS export..."
          npx expo export --platform ios
          echo "ğŸ” Verifying Android export..."
          npx expo export --platform android
          echo "âœ… Export verification complete"
        
      - name: ğŸ“± Test EAS Build Configuration
        run: |
          if [ -z "${{ env.EXPO_TOKEN }}" ]; then
            echo "EXPO_TOKEN not available - skipping EAS dry run"
            exit 0
          fi
          npx eas build --platform ios --profile testflight --dry-run
        continue-on-error: true

  # Dependency Analysis - Optional, runs in parallel
  analyze-npm-dependencies:
    name: ğŸ“¦ Analyze NPM Dependencies
    runs-on: ubuntu-latest
    timeout-minutes: 5
    continue-on-error: true
    if: github.event_name == 'pull_request'
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: âš¡ Install dependencies
        run: npm ci --legacy-peer-deps
        
      - name: ğŸ“¦ Check for Outdated Dependencies
        run: |
          echo "ğŸ” Checking for outdated dependencies..."
          npm outdated || true
          echo "ğŸ” Checking for unused dependencies..."
          npx depcheck || true
        continue-on-error: true
        
      - name: ğŸ“Š Measure Bundle Size
        run: |
          echo "ğŸ“Š Analyzing bundle size..."
          npx expo export --platform ios
          du -sh dist/ || echo "Bundle analysis complete"
        continue-on-error: true

  # Production Build - Final step, depends on everything critical
  build-for-testflight-production:
    name: ğŸš€ Build for TestFlight Production
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [run-unit-tests-with-coverage, verify-expo-build-process, run-maestro-integration-tests, analyze-code-quality-with-sonarqube]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: âš¡ Install dependencies
        run: npm ci --legacy-peer-deps
        
      - name: ğŸ”§ Setup EAS CLI
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}
        
      - name: ğŸš€ Execute Production Build for TestFlight
        run: |
          if [ -z "$EXPO_TOKEN" ]; then
            echo "âŒ EXPO_TOKEN not available - cannot build for production"
            exit 1
          fi
          echo "ğŸ”¨ Building for TestFlight..."
          eas build --platform ios --profile testflight --auto-submit
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }} 